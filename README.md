# mikbsn

## Сборка и запуск с эмулятором
1. Создайте виртуальные serial с помощью socat:
	```
	socat -d -d pty,raw,echo=0 pty,raw,echo=0
	```
	вы получите подобный вывод:
	```
	socat[7282] N PTY is /dev/pts/1
	socat[7282] N PTY is /dev/pts/2
	socat[7282] N starting data transfer loop with FDs [5,5] and [7,7]
	```
	укажите в `config.h` любой из этих устройств, затем укажите его же в `main.py`
2. Выполните `make` для сборки
3. Запустите `main.py`, поставьте путевые точки на карте, укажите скорость БПЛА, начните симуляцию
4. `make run` для запуска процессов


## Архитектура ПО
Система работает в ОС Linux. Все вычислительные процессы выделены в отдельные сервисы ОС. Для обеспечения требования к предоставлению данных о геолокации БВС с частотой 5Гц необходимо четко распределять ресурсы системы между процессами. 
Вот краткий обзор на сервисы, их назначение и принцип работы (также см. диаграмму):
1. Сервис работы с модулем SIM
	1. При запуске конфигурирует SIM командой `AT+CENG=1,1`
	2. Отправляет `AT+CENG?` на модуль SIM
	3. При получении ответа парсит из него *MCC*, *MNC*, *CellID*, *RSSI* вышек, затем сразу же снова отправляет `AT+CENG?`
	4. Отправляет полученные данные по UNIX сокету на сервис *2*
2. Сервис работы с базой данных. 
	1. Единожды при запуске парсит базу данных, создает хэш таблицу и наполняет ее данными 
	2. Принимает *MCC*, *MNC*, *CellId*, *RSSI* по UNIX сокету
	3. Ищет широту (*LONG*) и долготу (*LAT*) вышки по полученным параметрам
	4. По другому UNIX сокету передает *LONG*, *LAT* и *RSSI* на сервис *3*
3. Сервис вычисления геолокации
	1. Получает *LONG*, *LAT*, *RSSI*
	2. По полученным данным вычисляет свою геолокацию методом трилатерации
	3. Логирует вычисленную геолокацию в формате
	`<ГГГГ:ММ:ДД ЧЧ:ММ:СС>, <LONG>, <LAT>`
	4. Если данные от SIM не успели прийти до наступления дедлайна 200мс, то подразумевается использование различных способов экстраполяции по данным акселерометра, полученным по mavlink от полетного контроллера.
Так же для работы с *preempt-rt* ядром есть сервис, отправляющий сигнал на вычисление геолокации сервису *3*.
